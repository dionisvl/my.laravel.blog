version: "3.7"
services:
    gateway:
        build:
            context: gateway/.docker
            dockerfile: production/nginx/Dockerfile
        volumes:
            - /etc/letsencrypt:/etc/letsencrypt:ro
            - /var/www:/var/www:ro
#            - /etc/nginx/sites-available:/etc/nginx/sites-available:rw
#            - /etc/nginx/sites-enabled:/etc/nginx/sites-enabled:ro
        ports:
            - "80:80"
            - "443:443"
#
    phpqa-nginx:
        build:
            context: app/.docker
            dockerfile: common/nginx/Dockerfile
        volumes:
            - ./app:/app

    php-fpm:
        build:
            context: app/.docker
            dockerfile: common/php-fpm/Dockerfile
        environment:
            APP_ENV: dev
            APP_DEBUG: 1
            PHP_IDE_CONFIG: serverName=${SERVER_NAME}
            DB_HOST: ${DB_HOST}
            DB_USER: root
            DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            DB_NAME: ${MYSQL_DATABASE}
            MAILER_HOST: mailer
            MAILER_PORT: 1025
            MAILER_USER: app
            MAILER_PASSWORD: secret
            MAILER_ENCRYPTION: tcp
            MAILER_FROM_EMAIL: mail@app.test
            FRONTEND_URL: http://localhost:8080
            SENTRY_DSN: ""
        volumes:
            - ./app:/app

    mysql:
        image: mysql:${MYSQL_VERSION}
        container_name: ${DB_HOST}
        environment:
            - MYSQL_DATABASE=${MYSQL_DATABASE}
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
            - MYSQL_USER=${MYSQL_USER}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD}
        volumes:
            - "./data/db/mysql/my.cnf:/etc/mysql/conf.d/my.cnf"
            - "./data/db/mysql/db_data:/var/lib/mysql"
        ports:
            - "8989:3306"

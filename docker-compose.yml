version: "3.9"
services:
    gateway-nginx:
        build:
            dockerfile: gateway/nginx/Dockerfile
        ports:
            - "80:80"
            - "8080:8080"
            - "443:443"
            - "777:777"# test nginx
        volumes:
            - ./gateway/nginx/myTemplates:/etc/nginx/myTemplates
            # Copy all additional sites to Nginx container
            - ./gateway/nginx/sites:/etc/nginx/sites-enabled
            # For access to static sites directly(by nginx config)
            - /var/www:/var/www:rw
            - ./gateway/nginx/letsencrypt:/etc/letsencrypt
        environment:
            - APP_ENV=${APP_ENV:-dev}
        command: sh -c "envsubst \"`env | awk -F = '{printf \" $$%s\", $$1}'`\" < /etc/nginx/myTemplates/${APP_ENV}.conf.template > /etc/nginx/sites-enabled/phpqa.ru.autogenerated.conf && nginx -g 'daemon off;'"

    certbot:
        image: certbot/certbot:v2.6.0
        volumes:
            - ./gateway/nginx/letsencrypt:/etc/letsencrypt
            - ./gateway/nginx/letsencrypt/logs:/var/log/letsencrypt
            - ./data/certbot/www:/var/www/certbot
        #command: certonly --webroot --webroot-path=/var/www/certbot --email ${CERTBOT_EMAIL} --agree-tos --no-eff-email --force-renewal --expand -d ${CERTBOT_DOMAINS}

    php-fpm:
        build:
            context: app/.docker
            dockerfile: php-fpm/Dockerfile
        container_name: php-fpm
        environment:
#            APP_DEBUG: ${APP_DEBUG}
            PHP_IDE_CONFIG: serverName=${SERVER_NAME}
            DB_HOST: ${DB_HOST}
            DB_USER: ${MYSQL_ROOT_USER}
            DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            DB_NAME: ${MYSQL_DATABASE}
            MAILER_HOST: ${MAILER_HOST}
            MAILER_PORT: ${MAILER_PORT}
            MAILER_USER: ${MAILER_USER}
            MAILER_PASSWORD: ${MAILER_PASSWORD}
            MAILER_ENCRYPTION: ${MAILER_ENCRYPTION}
            MAILER_FROM_EMAIL: ${MAILER_FROM_EMAIL}
            SENTRY_DSN: ${SENTRY_DSN}
        volumes:
            - /var/www:/var/www:rw
            - ./app:/app

    mysql:
        image: mysql:${MYSQL_VERSION}
        container_name: ${DB_HOST}
        environment:
            - MYSQL_DATABASE=${MYSQL_DATABASE}
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
            - MYSQL_USER=${MYSQL_USER}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD}
        volumes:
            - "./data/db/mysql/my.cnf:/etc/mysql/conf.d/my.cnf"
            - "./data/db/mysql/db_data:/var/lib/mysql"
        ports:
            - "8989:3306"
        security_opt:
            - seccomp:unconfined

    node:
        build:
            context: app/.docker/node
        container_name: node-phpqa
        volumes:
            - ./app:/app

#    mailer:
#        image: mailhog/mailhog
#        environment:
#            MAILER_HOST: ${MAILER_HOST}
#            MAILER_PORT: ${MAILER_PORT}
#            MAILER_USER: ${MAILER_USER}
#            MAILER_PASSWORD: ${MAILER_PASSWORD}
#            MAILER_ENCRYPTION: ${MAILER_ENCRYPTION}
#            MAILER_FROM_EMAIL: ${MAILER_FROM_EMAIL}
#        ports:
#            - "1025:1025"   # smtp server
#            - "8025:8025"   # web ui
